- hosts: backends
  remote_user: ubuntu
  vars:
    app_location: /home/ubuntu/app
    repo_url: https://github.com/decentraland/marketplace.git

  tasks:
    - name: Base packages
      block:
        - name: Update packages
          apt:
            update_cache: yes
        - name: Upgrade packages
          apt:
            name: "*"
            state: latest
            force_apt_get: true
        - name: Autoremove packages
          apt:
            autoremove: yes
      become: yes
      become_method: sudo

    - name: Install nodejs
      block:
        - name: Get nodejs package  
          get_url: 
            url: https://deb.nodesource.com/setup_8.x
            dest: /tmp/nodesource_setup.sh
        - name: Update apt source
          shell: bash /tmp/nodesource_setup.sh
        - name: Update packages
          apt:
            update_cache: yes
        - name: Install nodejs
          apt:
            name: nodejs
            state: present
      become: yes
      become_method: sudo

    - name: Install application
      block:
        - name: Clone repo
          git:
            repo: "{{ repo_url }}"
            dest: "{{ app_location }}"
            version: chore/ansible-setup-server
        - name: Install node packages
          shell: npm install
          args:
            chdir: "{{ app_location }}"

    - name: Setup supervisor
      block:
        - name: Install supervisor
          apt:
            name: supervisor
            state: present
        - name: App config file
          copy:
            src: "{{ app_location }}/etc/supervisor/mkt-app.conf"
            dest: /etc/supervisor/conf.d
            remote_src: yes
        - name: Monitor config file
          copy:
            src: "{{ app_location }}/etc/supervisor/mkt-monitor.conf"
            dest: /etc/supervisor/conf.d
            remote_src: yes
        - name: Reload app
          supervisorctl:
            name: 'app:'
            state: restarted
        - name: Reload monitor
          supervisorctl:
            name: monitor
            state: restarted
      become: yes
      become_method: sudo
